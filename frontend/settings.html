<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YOLO 偵測設定</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    label { display: block; margin-top: 10px; }
    input, select { padding: 5px; margin-top: 5px; width: 200px; }
    button { margin-top: 20px; padding: 10px 20px; }
    #message { margin-top: 15px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>YOLO 偵測參數設定</h2>

  <label>
    選擇攝影機:
    <select id="cameraSelect"></select>
  </label>

  <form id="yoloForm">
    <label>Confidence threshold: <input type="number" step="0.01" min="0" max="1" name="confidence_threshold"></label>
    <label>iou threshold: <input type="number" step="0.01" min="0" max="1" name="iou_threshold"></label>
    <label>顯示框框: 
      <select name="draw_bbox">
        <option value="true">是</option>
        <option value="false">否</option>
      </select>
    </label>
    <button type="submit">更新設定</button>
  </form>
  <div id="message"></div>

<script>
const API_URL = 'http://localhost:8000';
const cameraSelect = document.getElementById('cameraSelect');
const form = document.getElementById('yoloForm');
const message = document.getElementById('message');

// 取得 token
const token = localStorage.getItem('token') || sessionStorage.getItem('token');
if (!token) {
    alert('請先登入');
    window.location.href = 'login.html';
}

// 載入攝影機列表
async function loadCameras() {
    try {
        const res = await fetch(`${API_URL}/api/cameras`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('無法載入攝影機列表');
        const cameras = await res.json();
        cameraSelect.innerHTML = '<option value="">請選擇攝影機</option>';
        cameras.forEach(cam => {
            const option = document.createElement('option');
            option.value = cam.id;
            option.textContent = cam.camera_name;
            cameraSelect.appendChild(option);
        });
    } catch (error) {
        console.error(error);
        message.style.color = 'red';
        message.textContent = '載入攝影機列表失敗';
    }
}

// 選擇攝影機後載入設定
cameraSelect.addEventListener('change', async () => {
    const camId = cameraSelect.value;
    if (!camId) return;

    try {
        const res = await fetch(`${API_URL}/api/cameras/${camId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('無法載入攝影機設定');
        const cam = await res.json();

        form.confidence_threshold.value = cam.confidence_threshold ?? 0.3;
        form.iou_threshold.value = cam.iou_threshold ?? 0.5;
        form.draw_bbox.value = cam.draw_bbox ? 'true' : 'false';
        message.textContent = '';
    } catch (error) {
        console.error(error);
        message.style.color = 'red';
        message.textContent = '載入攝影機設定失敗';
    }
});

// 提交更新
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const camId = cameraSelect.value;
    if (!camId) return alert('請先選擇攝影機');

    const data = {
        confidence_threshold: parseFloat(form.confidence_threshold.value),
        iou_threshold: parseFloat(form.iou_threshold.value),
        draw_bbox: form.draw_bbox.value === 'true'
    };

    try {
        const res = await fetch(`${API_URL}/api/cameras/${camId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(data)
        });

        if (res.ok) {
            message.style.color = 'green';
            message.textContent = '更新成功！';
        } else {
            const err = await res.json();
            message.style.color = 'red';
            message.textContent = `錯誤: ${err.detail || res.status}`;
        }
    } catch (error) {
        console.error(error);
        message.style.color = 'red';
        message.textContent = '更新失敗，請檢查控制台';
    }
});

// 初始載入攝影機
loadCameras();
</script>

</body>
</html>
