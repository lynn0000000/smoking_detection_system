<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚ç›£æ§ - å¸è¸ç›£æ§ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="./css/monitor.css">
</head>
<body>
    <!--æ”¶ç¸®å´é‚Šæ¬„æŒ‰éˆ•-->
    <div class="toggle-btn" onclick="toggleSidebar()">
        <i class="bi bi-list"></i>
    </div>
    <!-- å´é‚Šæ¬„ -->
    <div class="sidebar">
        <div class="logo">
            <i class="bi bi-camera-video-off"></i>
            <h5 class="mt-2">å¸è¸ç›£æ§ç³»çµ±</h5>
        </div>
        
        <nav class="nav flex-column">
            <a class="nav-link" href="dashboard.html">
                <i class="bi bi-speedometer2"></i> å„€è¡¨æ¿
            </a>
            <a class="nav-link" href="cameras.html">
                <i class="bi bi-camera"></i> æ”å½±æ©Ÿç®¡ç†
            </a>
            <a class="nav-link active" href="monitor.html">
                <i class="bi bi-display"></i> å³æ™‚ç›£æ§
            </a>
            <a class="nav-link" href="detections.html">
                <i class="bi bi-list-ul"></i> åµæ¸¬è¨˜éŒ„
            </a>
            <a class="nav-link" href="settings.html">
                <i class="bi bi-gear"></i> ç³»çµ±è¨­å®š
            </a>
            <a class="nav-link" href="#" onclick="logout()">
                <i class="bi bi-box-arrow-right"></i> ç™»å‡º
            </a>
        </nav>
    </div>
    
    <!-- ä¸»è¦å…§å®¹ -->
    <div class="main-content">
        <h2 class="mb-4"><i class="bi bi-display"></i> å³æ™‚ç›£æ§</h2>
        
        <!-- æ”å½±æ©Ÿé¸æ“‡ -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3"><i class="bi bi-camera"></i> é¸æ“‡æ”å½±æ©Ÿ</h5>
                <div id="cameraSelector" class="row g-3">
                    <div class="col-12 text-center text-muted">
                        è¼‰å…¥ä¸­...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è¦–è¨Šç•«é¢ -->
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-body p-0">
                        <div class="video-container">
                            <div id="videoPlaceholder" class="video-placeholder">
                                <i class="bi bi-camera-video-off"></i>
                                <p>è«‹é¸æ“‡æ”å½±æ©Ÿé–‹å§‹ç›£æ§</p>
                            </div>
                            <canvas id="displayCanvas"></canvas>
                            <div id="statusIndicator" class="status-indicator status-offline">
                                <i class="bi bi-wifi-off"></i> é›¢ç·š
                            </div>
                            <div id="detectionAlert" class="detection-alert">
                                <i class="bi bi-exclamation-triangle"></i> åµæ¸¬åˆ°å¸è¸è¡Œç‚ºï¼
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ§åˆ¶é¢æ¿ -->
                <div class="control-panel">
                    <div class="row g-3 align-items-center">
                        <div class="col-auto">
                            <button id="startBtn" class="btn btn-success" onclick="startMonitoring()" disabled>
                                <i class="bi bi-play-fill"></i> é–‹å§‹ç›£æ§
                            </button>
                        </div>
                        <div class="col-auto">
                            <button id="stopBtn" class="btn btn-danger" onclick="stopMonitoring()" disabled>
                                <i class="bi bi-stop-fill"></i> åœæ­¢ç›£æ§
                            </button>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-outline-secondary" onclick="takeScreenshot()">
                                <i class="bi bi-camera"></i> æˆªåœ–
                            </button>
                        </div>
                        <div class="col-auto ms-auto">
                            <span id="fpsCounter" class="text-muted">FPS: 0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- çµ±è¨ˆè³‡è¨Š -->
            <div class="col-lg-4">
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title mb-3"><i class="bi bi-graph-up"></i> å³æ™‚çµ±è¨ˆ</h5>
                        
                        <div class="stats-box mb-3">
                            <h4 id="frameCount">0</h4>
                            <p>å·²è™•ç†å¹€æ•¸</p>
                        </div>
                        
                        <div class="stats-box mb-3">
                            <h4 id="detectionCount">0</h4>
                            <p>åµæ¸¬æ¬¡æ•¸</p>
                        </div>
                        
                        <div class="stats-box">
                            <h4 id="avgConfidence">0%</h4>
                            <p>å¹³å‡ä¿¡å¿ƒåº¦</p>
                        </div>
                    </div>
                </div>
                
                <!-- æœ€è¿‘åµæ¸¬ -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3"><i class="bi bi-clock-history"></i> æœ€è¿‘åµæ¸¬</h5>
                        <div id="recentDetections" class="list-group list-group-flush">
                            <div class="text-center text-muted py-3">
                                å°šç„¡åµæ¸¬è¨˜éŒ„
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- <script>
        const API_URL = 'http://localhost:8000';
        const WS_URL = 'ws://localhost:8000';
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        
        if (!token) {
            window.location.href = 'login.html';
        }
        
        let selectedCamera = null;
        let websocket = null;
        let isMonitoring = false;
        let frameCount = 0;
        let detectionCount = 0;
        let totalConfidence = 0;
        let fpsInterval;
        let latestDetection = null;
        let videoStream = null;
        
        // è¼‰å…¥æ”å½±æ©Ÿåˆ—è¡¨
        async function loadCameras() {
            try {
                const response = await fetch(`${API_URL}/api/cameras`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const cameras = await response.json();
                displayCameras(cameras);
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        function displayCameras(cameras) {
            const container = document.getElementById('cameraSelector');
            
            if (cameras.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center">
                        <p class="text-muted">æ²’æœ‰å¯ç”¨çš„æ”å½±æ©Ÿ</p>
                        <a href="cameras.html" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> æ–°å¢æ”å½±æ©Ÿ
                        </a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = cameras.map(camera => `
                <div class="col-md-6 col-lg-4">
                    <div class="card camera-select-card" onclick="selectCamera(${camera.id}, '${camera.camera_name}', '${camera.api_key}')">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="bi bi-camera"></i> ${camera.camera_name}
                            </h6>
                            <p class="card-text mb-2">
                                <small class="text-muted">
                                    <i class="bi bi-tag"></i> ${camera.camera_type.toUpperCase()}<br>
                                    <i class="bi bi-geo-alt"></i> ${camera.location || 'æœªè¨­å®š'}
                                </small>
                            </p>
                            <span class="badge ${camera.is_online ? 'bg-success' : 'bg-secondary'}">
                                ${camera.is_online ? 'ç·šä¸Š' : 'é›¢ç·š'}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function selectCamera(id, name, apiKey) {
            document.querySelectorAll('.camera-select-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            event.currentTarget.classList.add('selected');
            
            selectedCamera = { id, name, apiKey };
            document.getElementById('startBtn').disabled = false;
            
            console.log('å·²é¸æ“‡æ”å½±æ©Ÿ:', name);
        }
        
        async function startMonitoring() {
            if (!selectedCamera) {
                alert('è«‹å…ˆé¸æ“‡æ”å½±æ©Ÿ');
                return;
            }
            
            if (isMonitoring) {
                alert("ç›£æ¸¬ä¸­");
                return;

            }
            
            try {
                const wsUrl = `${WS_URL}/ws/upload/${selectedCamera.apiKey}`;
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = () => {
                    console.log('âœ… WebSocket å·²é€£ç·š');
                    isMonitoring = true;
                    updateStatus('online');
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    document.getElementById('videoPlaceholder').style.display = 'none';
                    document.getElementById('displayCanvas').style.display = 'block';
                    startFpsCounter();
                };


                websocket.onmessage = async (event) => {
                    console.log('ğŸ“¨ æ”¶åˆ°åŸå§‹è¨Šæ¯');
                    
                    let data;
                    try {
                        data = JSON.parse(event.data); //é€é JSON.parse()ï¼Œè®Šæˆå¯ä»¥ç”¨ obj.name ç›´æ¥å­˜å–çš„ JS ç‰©ä»¶ã€‚
                        console.log('âœ… JSON è§£ææˆåŠŸ:', data);
                    } catch (error) {
                        console.error('âŒ JSON è§£æå¤±æ•—:', error);
                        console.error('åŸå§‹è³‡æ–™:', event.data);
                        return; // ç›´æ¥è¿”å›,ä¸è™•ç†
                    }
                    
                    console.log('ğŸ” æ”¶åˆ°åµæ¸¬çµæœ:', data);
                    
                    try {
                        handleServerMessage(data);
                        console.log('âœ… handleServerMessage å®Œæˆ');
                    } catch (error) {
                        console.error('âŒ handleServerMessage éŒ¯èª¤:', error);
                        console.trace();
                        // ä¸è¦è®“éŒ¯èª¤å‚³æ’­
                    }
                };
                
                websocket.onerror = (error) => {
                    console.error('âŒ WebSocket éŒ¯èª¤:', error);

                };
                
                websocket.onclose = () => {
                    console.log('âš ï¸ WebSocket å·²æ–·ç·š');
                    
                    if (isMonitoring) {
                        // ä¸è¦è‡ªå‹•åœæ­¢,ä¿æŒç›£æ§ç‹€æ…‹
                        console.log('é€£ç·šä¸­æ–·,å˜—è©¦ç¶­æŒæœ¬åœ°é¡¯ç¤º');
                        
                    }
                };
                
                await startVideoCapture();
                
            } catch (error) {
                console.error('å•Ÿå‹•ç›£æ§å¤±æ•—:', error);
                alert('å•Ÿå‹•ç›£æ§å¤±æ•—');
            }
        }
        

        async function startVideoCapture() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 } 
                });
                
                videoStream = stream;
                const video = document.createElement('video');
                video.srcObject = stream;
                video.play();
                
                const captureCanvas = document.createElement('canvas');
                captureCanvas.width = 640;
                captureCanvas.height = 480;
                const captureCtx = captureCanvas.getContext('2d');
                
                const displayCanvas = document.getElementById('displayCanvas');
                displayCanvas.width = 640;
                displayCanvas.height = 480;
                const displayCtx = displayCanvas.getContext('2d');  
                
                // âœ… åŠ å…¥è™•ç†ä¸­æ¨™è¨˜,é¿å…ä¸¦ç™¼å•é¡Œ
                let isProcessing = false;
                let skippedFrames = 0;
                
                const captureInterval = setInterval(() => {
                    if (!isMonitoring) {
                        clearInterval(captureInterval);
                        stream.getTracks().forEach(track => track.stop());
                        console.log('ğŸ“· æ”å½±æ©Ÿå·²åœæ­¢');
                        return;
                    }
                    
                    // âœ… å¦‚æœé‚„åœ¨è™•ç†ä¸Šä¸€å¹€,è·³éé€™æ¬¡
                    if (isProcessing) {
                        skippedFrames++;
                        if (skippedFrames % 10 === 0) {
                            console.log(`â­ï¸ å·²è·³é ${skippedFrames} å¹€ (è™•ç†é€Ÿåº¦è¼ƒæ…¢)`);
                        }
                        return;
                    }
                    
                    isProcessing = true;
                    
                    try {
                        // ç¹ªè£½å½±åƒåˆ°é¡¯ç¤º canvas
                        displayCtx.drawImage(video, 0, 0, 640, 480);
                        
                        // ç¹ªè£½ bounding boxes
                        if (latestDetection && latestDetection.boxes) {
                            try {
                                drawBoundingBoxes(displayCtx, latestDetection.boxes);
                            } catch (error) {
                                console.error('âŒ drawBoundingBoxes éŒ¯èª¤:', error);
                            }
                        }
                        
                        // ç™¼é€åˆ°ä¼ºæœå™¨
                        captureCtx.drawImage(video, 0, 0, 640, 480);
                        
                        captureCanvas.toBlob((blob) => {
                            if (!blob) {
                                console.error('âŒ toBlob å¤±æ•—');
                                isProcessing = false;
                                return;
                            }
                            
                            const reader = new FileReader();
                            
                            reader.onerror = () => {
                                console.error('âŒ FileReader éŒ¯èª¤');
                                isProcessing = false;
                            };
                            
                            reader.onloadend = () => {
                                try {
                                    const base64data = reader.result.split(',')[1];
                                    
                                    if (websocket && websocket.readyState === WebSocket.OPEN) {
                                        websocket.send(JSON.stringify({
                                            type: "frame",
                                            data: base64data,
                                            timestamp: new Date().toISOString()
                                        }));
                                        
                                        frameCount++;
                                        const countEl = document.getElementById('frameCount');
                                        if (countEl) {
                                            countEl.textContent = frameCount;
                                        }
                                        
                                        // é‡ç½®è·³éè¨ˆæ•¸
                                        if (skippedFrames > 0) {
                                            skippedFrames = 0;
                                        }
                                    } else {
                                        console.warn('âš ï¸ WebSocket æœªé€£ç·š,è·³éç™¼é€');
                                    }
                                } catch (error) {
                                    console.error('âŒ ç™¼é€å¹€éŒ¯èª¤:', error);
                                } finally {
                                    // âœ… ç¢ºä¿è§£é–
                                    isProcessing = false;
                                }
                            };
                            
                            reader.readAsDataURL(blob);
                        }, 'image/jpeg', 0.8);
                        
                    } catch (error) {
                        console.error('âŒ æ•æ‰å¹€éŒ¯èª¤:', error);
                        isProcessing = false;
                    }
                    
                }, 100); // æ¯ 100ms ä¸€æ¬¡ (æœ€å¤š 10 FPS)
                
            } catch (error) {
                console.error('âŒ ç„¡æ³•å­˜å–æ”å½±æ©Ÿ:', error);
                alert('ç„¡æ³•å­˜å–æ”å½±æ©Ÿ,è«‹ç¢ºèªæ¬Šé™è¨­å®š');
                stopMonitoring();
            }
        }       

           
        function drawBoundingBoxes(ctx, boxes) {
            boxes.forEach(box => {
                const { x1, y1, x2, y2, confidence, label } = box;
                
                // è¨­å®šé¡è‰² (äºº=ç¶ è‰², é¦™è¸=ç´…è‰²)
                const color = label === 'person' ? '#00ff00' : '#ff0000';
                
                // ç¹ªè£½æ¡†
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
                
                // ç¹ªè£½æ¨™ç±¤èƒŒæ™¯
                ctx.fillStyle = color;
                const text = `${label} ${(confidence * 100).toFixed(0)}%`;
                const textWidth = ctx.measureText(text).width;
                ctx.fillRect(x1, y1 - 25, textWidth + 10, 25);
                
                // ç¹ªè£½æ¨™ç±¤æ–‡å­—
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 16px Arial';
                ctx.fillText(text, x1 + 5, y1 - 7);
            });
        }
         
        
        
        function handleServerMessage(data) {
            console.log('ğŸ“¨ æ”¶åˆ°è¨Šæ¯:', data.type);
            
            try {
                const detectionData = data.data || data;
                
                if (detectionData.boxes) {
                    latestDetection = detectionData;
                }
                
                // âœ… ç›´æ¥æª¢æŸ¥ is_smoking (ä¸éœ€è¦æª¢æŸ¥ type === 'alert')
                if (detectionData.is_smoking === true) {
                    console.log('âš ï¸ åµæ¸¬åˆ°å¸è¸!');
                    detectionCount++;
                    document.getElementById('detectionCount').textContent = detectionCount;
                }
                
                // æ›´æ–°ä¿¡å¿ƒåº¦
                // if (detectionData.max_confidence !== undefined) {
                //     totalConfidence += detectionData.max_confidence;
                //     const avgConf = (totalConfidence / frameCount * 100).toFixed(1);
                //     document.getElementById('avgConfidence').textContent = avgConf + '%';
                // }
                const alpha = 0.2; // å¹³æ»‘ä¿‚æ•¸ 0~1
                if (detectionData.max_confidence !== undefined) {
                    const confPercent = detectionData.max_confidence * 100;
                    avgConfidence = avgConfidence ? (alpha * confPercent + (1-alpha) * avgConfidence) : confPercent;
                    document.getElementById('avgConfidence').textContent = avgConfidence.toFixed(1) + '%';
                }

                
            } catch (error) {
                console.error('âŒ éŒ¯èª¤:', error);
            }
        }
                
        function addRecentDetection(data) {
            try {
                const container = document.getElementById('recentDetections');
                if (!container) {
                    console.error('æ‰¾ä¸åˆ° recentDetections å…ƒç´ ');
                    return;
                }
                
                if (container.querySelector('.text-center')) {
                    container.innerHTML = '';
                }
                
                const item = document.createElement('div');
                item.className = 'list-group-item';
                const confidence = data.max_confidence || data.confidence || 0;
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-exclamation-triangle text-danger"></i>
                            <strong>å¸è¸åµæ¸¬</strong><br>
                            <small class="text-muted">${new Date().toLocaleTimeString('zh-TW')}</small>
                        </div>
                        <span class="badge bg-danger">${(confidence * 100).toFixed(1)}%</span>
                    </div>
                `;
                
                container.prepend(item);
                
                while (container.children.length > 10) {
                    container.removeChild(container.lastChild);
                }
            } catch (error) {
                console.error('âŒ addRecentDetection éŒ¯èª¤:', error);
            }
        }

        function stopMonitoring() {
            isMonitoring = false;
            
            if (websocket) {
                websocket.close();
                websocket = null;
            }
            
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            updateStatus('offline');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('videoPlaceholder').style.display = 'flex';
            document.getElementById('displayCanvas').style.display = 'none';
            
            stopFpsCounter();
            latestDetection = null;
        }
        
        function updateStatus(status) {
            const indicator = document.getElementById('statusIndicator');
            indicator.className = 'status-indicator';
            
            if (status === 'online') {
                indicator.classList.add('status-online');
                indicator.innerHTML = '<i class="bi bi-wifi"></i> ç·šä¸Š';
            } else if (status === 'connecting') {
                indicator.classList.add('status-connecting');
                indicator.innerHTML = '<i class="bi bi-hourglass-split"></i> é€£ç·šä¸­';
            } else {
                indicator.classList.add('status-offline');
                indicator.innerHTML = '<i class="bi bi-wifi-off"></i> é›¢ç·š';
            }
        }
        
        function startFpsCounter() {
            let lastFrame = frameCount;
            fpsInterval = setInterval(() => {
                const fps = frameCount - lastFrame;
                document.getElementById('fpsCounter').textContent = `FPS: ${fps}`;
                lastFrame = frameCount;
            }, 1000);
        }
        
        function stopFpsCounter() {
            if (fpsInterval) {
                clearInterval(fpsInterval);
                document.getElementById('fpsCounter').textContent = 'FPS: 0';
            }
        }
        
        function takeScreenshot() {
            const canvas = document.getElementById('displayCanvas');
            if (canvas.style.display === 'block') {
                const link = document.createElement('a');
                link.download = `screenshot_${Date.now()}.jpg`;
                link.href = canvas.toDataURL('image/jpeg');
                link.click();
            }
        }
        
        function logout() {
            stopMonitoring();
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = 'login.html';
        }
        
         //å‹•æ…‹å°è¦½åˆ—
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleBtn = document.querySelector('.toggle-btn');

            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('collapsed');
            toggleBtn.classList.toggle('collapsed');
        }
        // ğŸ”¥ é¸æ“‡æ”å½±æ©Ÿæ™‚å„²å­˜å®Œæ•´è³‡è¨Š
        function selectCamera(id, name, apiKey, type, source) {
            document.querySelectorAll('.camera-select-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            event.currentTarget.classList.add('selected');
            
            selectedCamera = { 
                id, 
                name, 
                apiKey,
                type,
                source  // ğŸ”¥ é€™è£¡æœƒæ˜¯ deviceId
            };
            
            document.getElementById('startBtn').disabled = false;
            console.log('å·²é¸æ“‡æ”å½±æ©Ÿ:', selectedCamera);
            
            updateSelectedCameraDisplay(name);
        }

        // ğŸ”¥ ä¿®æ”¹ startVideoCapture ä½¿ç”¨æ­£ç¢ºçš„ deviceId
        async function startVideoCapture() {
            try {
                let constraints;
                
                if (selectedCamera) {
                    const { type, source } = selectedCamera;
                    
                    if (type === 'rtsp') {
                        alert('RTSP ä¸²æµéœ€è¦ä½¿ç”¨å¾Œç«¯è™•ç†\nè«‹åŸ·è¡Œ: camera_client.py');
                        stopMonitoring();
                        return;
                    }
                    
                    // ğŸ”¥ ä½¿ç”¨å„²å­˜çš„ deviceId
                    if (type === 'local' || type === 'usb') {
                        console.log('ğŸ¥ ä½¿ç”¨æ”å½±æ©Ÿ deviceId:', source);
                        
                        constraints = {
                            video: {
                                deviceId: { exact: source },  // ä½¿ç”¨ç²¾ç¢ºçš„ deviceId
                                width: { ideal: 640 },
                                height: { ideal: 480 }
                            }
                        };
                    }
                } else {
                    // æ²’æœ‰é¸æ“‡æ”å½±æ©Ÿï¼Œä½¿ç”¨é è¨­
                    constraints = {
                        video: {
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        }
                    };
                }
                
                console.log('ğŸ“¹ æ”å½±æ©Ÿåƒæ•¸:', constraints);
                
                // å•Ÿå‹•æ”å½±æ©Ÿ
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // é¡¯ç¤ºå¯¦éš›ä½¿ç”¨çš„æ”å½±æ©Ÿ
                const track = stream.getVideoTracks()[0];
                const settings = track.getSettings();
                console.log('âœ… å·²å•Ÿå‹•æ”å½±æ©Ÿ:', track.label);
                console.log('   Device ID:', settings.deviceId);
                console.log('   è§£æåº¦:', settings.width, 'x', settings.height);
                
                showNotification(`å·²å•Ÿå‹•: ${track.label}`, 'success');
                
                // ... å…¶é¤˜ç¨‹å¼ç¢¼ä¿æŒä¸è®Š ...
                
            } catch (error) {
                console.error('âŒ ç„¡æ³•å­˜å–æ”å½±æ©Ÿ:', error);
                
                let errorMsg = 'ç„¡æ³•å­˜å–æ”å½±æ©Ÿ\n\n';
                
                if (error.name === 'NotAllowedError') {
                    errorMsg += 'åŸå› ï¼šæ¬Šé™è¢«æ‹’çµ•';
                } else if (error.name === 'NotFoundError') {
                    errorMsg += 'åŸå› ï¼šæ‰¾ä¸åˆ°æ”å½±æ©Ÿ';
                } else if (error.name === 'OverconstrainedError') {
                    errorMsg += 'åŸå› ï¼šæŒ‡å®šçš„æ”å½±æ©Ÿä¸å¯ç”¨\nå¯èƒ½è©²è£ç½®å·²è¢«ç§»é™¤æˆ–æ­£è¢«å…¶ä»–ç¨‹å¼ä½¿ç”¨';
                } else {
                    errorMsg += 'éŒ¯èª¤: ' + error.message;
                }
                
                alert(errorMsg);
                stopMonitoring();
            }
        }
        // åˆå§‹è¼‰å…¥
        loadCameras();
        
        window.addEventListener('beforeunload', (e) => {
        if (isMonitoring) {
            // åªæ˜¯è¨˜éŒ„,ä¸è¦åœæ­¢ç›£æ§
            console.log('âš ï¸ é é¢å³å°‡é—œé–‰');
            // ä¸è¦å‘¼å« stopMonitoring()
            }
        });
    </script> -->
    <script>
    const API_URL = 'http://localhost:8000';
    const WS_URL = 'ws://localhost:8000';
    const token = localStorage.getItem('token') || sessionStorage.getItem('token');
    
    if (!token) {
        window.location.href = 'login.html';
    }
    
    let selectedCamera = null;
    let websocket = null;
    let isMonitoring = false;
    let frameCount = 0;
    let detectionCount = 0;
    let avgConfidence = 0;
    let fpsInterval;
    let latestDetection = null;
    let videoStream = null;
    
    async function loadCameras() {
    try {
        const response = await fetch(`${API_URL}/api/cameras`, {
            headers: { 
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        // ğŸ”¥ åŠ é€™æ®µï¼šè™•ç† 401
        if (response.status === 401) {
            alert('ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥');
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = 'login.html';
            return;
        }
        
        const cameras = await response.json();
        
        // ğŸ”¥ åŠ é€™æ®µï¼šæª¢æŸ¥æ˜¯å¦ç‚ºé™£åˆ—
        if (!Array.isArray(cameras)) {
            console.error('API å›å‚³æ ¼å¼éŒ¯èª¤:', cameras);
            displayCameras([]);
            return;
        }
        
        displayCameras(cameras);
    } catch (error) {
        console.error('Error:', error);
        displayCameras([]); // ğŸ”¥ åŠ é€™è¡Œï¼šéŒ¯èª¤æ™‚é¡¯ç¤ºç©ºåˆ—è¡¨
    }
}
    
function displayCameras(cameras) {
    const container = document.getElementById('cameraSelector');
    
    if (cameras.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center">
                <p class="text-muted">æ²’æœ‰å¯ç”¨çš„æ”å½±æ©Ÿ</p>
                <a href="cameras.html" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> æ–°å¢æ”å½±æ©Ÿ
                </a>
            </div>
        `;
        return;
    }
    
    container.innerHTML = cameras.map(camera => `
        <div class="col-md-6 col-lg-4">
            <div class="card camera-select-card" 
                 data-camera-id="${camera.id}"
                 data-camera-name="${camera.camera_name}"
                 data-camera-apikey="${camera.api_key}"
                 data-camera-type="${camera.camera_type}"
                 data-camera-source='${camera.camera_source.replace(/'/g, "&apos;")}'
                 onclick="selectCameraById(${camera.id})">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="bi bi-camera"></i> ${camera.camera_name}
                    </h6>
                    <p class="card-text mb-2">
                        <small class="text-muted">
                            <i class="bi bi-tag"></i> ${camera.camera_type.toUpperCase()}<br>
                            <i class="bi bi-geo-alt"></i> ${camera.location || 'æœªè¨­å®š'}
                        </small>
                    </p>
                    <span class="badge ${camera.is_online ? 'bg-success' : 'bg-secondary'}">
                        <i class="bi bi-${camera.is_online ? 'wifi' : 'wifi-off'}"></i>
                        ${camera.is_online ? 'ç·šä¸Š' : 'é›¢ç·š'}
                    </span>
                </div>
            </div>
        </div>
    `).join('');
}

// ğŸ”¥ æ–°å¢é€™å€‹å‡½æ•¸ï¼šå¾ data å±¬æ€§è®€å–è³‡æ–™
function selectCameraById(id) {
    const card = event.currentTarget;
    
    document.querySelectorAll('.camera-select-card').forEach(c => {
        c.classList.remove('selected');
    });
    
    card.classList.add('selected');
    
    const name = card.getAttribute('data-camera-name');
    const apiKey = card.getAttribute('data-camera-apikey');
    const type = card.getAttribute('data-camera-type');
    const source = card.getAttribute('data-camera-source');
    
    selectedCamera = { id, name, apiKey, type, source };
    
    document.getElementById('startBtn').disabled = false;
    console.log('å·²é¸æ“‡æ”å½±æ©Ÿ:', selectedCamera);
    
    updateSelectedCameraDisplay(name, type);
}
    
    // ğŸ”¥ é¸æ“‡æ”å½±æ©Ÿ
    function selectCamera(id, name, apiKey, type, source) {
        document.querySelectorAll('.camera-select-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        event.currentTarget.classList.add('selected');
        
        selectedCamera = { 
            id, 
            name, 
            apiKey,
            type,
            source
        };
        
        document.getElementById('startBtn').disabled = false;
        console.log('å·²é¸æ“‡æ”å½±æ©Ÿ:', selectedCamera);
        
        // ğŸ”¥ å‘¼å«é¡¯ç¤ºå‡½æ•¸
        updateSelectedCameraDisplay(name, type);
    }
    
    // ğŸ”¥ é¡¯ç¤ºé¸ä¸­çš„æ”å½±æ©Ÿè³‡è¨Š
    function updateSelectedCameraDisplay(name, type) {
        const placeholder = document.getElementById('videoPlaceholder');
        if (placeholder && placeholder.style.display !== 'none') {
            placeholder.innerHTML = `
                <i class="bi bi-camera-video"></i>
                <p class="mt-3"><strong>å·²é¸æ“‡ï¼š${name}</strong></p>
                <p class="text-muted">é¡å‹ï¼š${type.toUpperCase()}</p>
                <p class="text-muted">é»æ“Šã€Œé–‹å§‹ç›£æ§ã€é–‹å§‹</p>
            `;
        }
    }
    
    // ğŸ”¥ é–‹å§‹ç›£æ§
    async function startMonitoring() {
        if (!selectedCamera) {
            alert('è«‹å…ˆé¸æ“‡æ”å½±æ©Ÿ');
            return;
        }
        
        if (isMonitoring) {
            console.warn('å·²åœ¨ç›£æ§ä¸­');
            return;
        }
        
        try {
            const wsUrl = `${WS_URL}/ws/upload/${selectedCamera.apiKey}`;
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = () => {
                console.log('âœ… WebSocket å·²é€£ç·š');
                isMonitoring = true;
                updateStatus('online');
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('videoPlaceholder').style.display = 'none';
                document.getElementById('displayCanvas').style.display = 'block';
                startFpsCounter();
            };

            websocket.onmessage = async (event) => {
                let data;
                try {
                    data = JSON.parse(event.data);
                    handleServerMessage(data);
                } catch (error) {
                    console.error('âŒ JSON è§£æå¤±æ•—:', error);
                }
            };
            
            websocket.onerror = (error) => {
                console.error('âŒ WebSocket éŒ¯èª¤:', error);
            };
            
            websocket.onclose = () => {
                console.log('âš ï¸ WebSocket å·²æ–·ç·š');
            };
            
            // ğŸ”¥ å•Ÿå‹•æ”å½±æ©Ÿ
            await startVideoCapture();
            
        } catch (error) {
            console.error('å•Ÿå‹•ç›£æ§å¤±æ•—:', error);
            alert('å•Ÿå‹•ç›£æ§å¤±æ•—: ' + error.message);
            stopMonitoring();
        }
    }
    
    // ğŸ”¥ å•Ÿå‹•æ”å½±æ©Ÿæ•æ‰
    async function startVideoCapture() {
    try {
        let constraints;
        
        if (selectedCamera) {
            const { type, source } = selectedCamera;
            
            console.log('ğŸ¥ æ”å½±æ©Ÿé¡å‹:', type);
            console.log('ğŸ¥ æ”å½±æ©Ÿä¾†æº:', source);
            
            if (type === 'rtsp') {
                alert('RTSP ä¸²æµéœ€è¦ä½¿ç”¨å¾Œç«¯è™•ç†');
                stopMonitoring();
                return;
            }
            
            // ğŸ”¥ æœ¬åœ°æˆ– USB æ”å½±æ©Ÿ
            if (type === 'local' || type === 'usb') {
                // ğŸ”¥ å…ˆæƒæç•¶å‰å¯ç”¨è£ç½®
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(d => d.kind === 'videoinput');
                
                console.log('ğŸ“¹ ç•¶å‰å¯ç”¨æ”å½±æ©Ÿ:', videoDevices.map(d => d.label));
                
                let targetDeviceId = null;
                
                // ğŸ”¥ å˜—è©¦è§£æ source
                try {
                    const cameraInfo = JSON.parse(source);
                    const savedLabel = cameraInfo.label;
                    const savedDeviceId = cameraInfo.deviceId;
                    
                    console.log('ğŸ” å°‹æ‰¾æ”å½±æ©Ÿ:', savedLabel);
                    
                    // ğŸ”¥ å„ªå…ˆç”¨ label æ¯”å°
                    const matchedByLabel = videoDevices.find(d => d.label === savedLabel);
                    if (matchedByLabel) {
                        targetDeviceId = matchedByLabel.deviceId;
                        console.log('âœ… é€éæ¨™ç±¤æ‰¾åˆ°:', matchedByLabel.label);
                    } else {
                        // ğŸ”¥ å†è©¦ deviceId
                        const matchedById = videoDevices.find(d => d.deviceId === savedDeviceId);
                        if (matchedById) {
                            targetDeviceId = matchedById.deviceId;
                            console.log('âœ… é€é ID æ‰¾åˆ°:', matchedById.label);
                        }
                    }
                    
                } catch (e) {
                    // ğŸ”¥ å¦‚æœä¸æ˜¯ JSONï¼Œå¯èƒ½æ˜¯èˆŠæ ¼å¼çš„ deviceId
                    console.log('âš ï¸ èˆŠæ ¼å¼ sourceï¼Œç›´æ¥ä½¿ç”¨');
                    targetDeviceId = source;
                }
                
                // ğŸ”¥ æª¢æŸ¥æ˜¯å¦æ‰¾åˆ°
                if (!targetDeviceId) {
                    const retry = confirm(
                        'æ‰¾ä¸åˆ°æŒ‡å®šçš„æ”å½±æ©Ÿè£ç½®ï¼\n\n' +
                        'å¯èƒ½åŸå› ï¼š\n' +
                        '1. è£ç½®å·²è¢«ç§»é™¤\n' +
                        '2. è£ç½®æ­£è¢«å…¶ä»–ç¨‹å¼ä½¿ç”¨\n' +
                        '3. è£ç½®åç¨±å·²è®Šæ›´\n\n' +
                        'æ˜¯å¦ä½¿ç”¨é è¨­æ”å½±æ©Ÿï¼Ÿ'
                    );
                    
                    if (!retry) {
                        stopMonitoring();
                        return;
                    }
                    
                    // ä½¿ç”¨ç¬¬ä¸€å€‹å¯ç”¨æ”å½±æ©Ÿ
                    if (videoDevices.length > 0) {
                        targetDeviceId = videoDevices[0].deviceId;
                        console.log('âš ï¸ ä½¿ç”¨é è¨­æ”å½±æ©Ÿ:', videoDevices[0].label);
                    } else {
                        throw new Error('æ²’æœ‰å¯ç”¨çš„æ”å½±æ©Ÿè£ç½®');
                    }
                }
                
                constraints = {
                    video: {
                        deviceId: { exact: targetDeviceId },
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                };
            } else {
                // æœªçŸ¥é¡å‹
                constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                };
            }
        } else {
            // æ²’æœ‰é¸æ“‡æ”å½±æ©Ÿ
            constraints = {
                video: {
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            };
        }
        
        console.log('ğŸ“¹ æ”å½±æ©Ÿåƒæ•¸:', constraints);
        
        if (!constraints || !constraints.video) {
            throw new Error('æ”å½±æ©Ÿåƒæ•¸è¨­å®šéŒ¯èª¤');
        }
        
        // å•Ÿå‹•æ”å½±æ©Ÿ
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        
        const track = stream.getVideoTracks()[0];
        const settings = track.getSettings();
        console.log('âœ… å·²å•Ÿå‹•æ”å½±æ©Ÿ:', track.label);
        console.log('   Device ID:', settings.deviceId);
        
        showNotification(`å·²å•Ÿå‹•: ${track.label}`, 'success');
        
        // ... å…¶é¤˜ç¨‹å¼ç¢¼ä¸è®Š ...
            
            videoStream = stream;
            const video = document.createElement('video');
            video.srcObject = stream;
            video.play();
            
            const captureCanvas = document.createElement('canvas');
            captureCanvas.width = 640;
            captureCanvas.height = 480;
            const captureCtx = captureCanvas.getContext('2d');
            
            const displayCanvas = document.getElementById('displayCanvas');
            displayCanvas.width = 640;
            displayCanvas.height = 480;
            const displayCtx = displayCanvas.getContext('2d');
            
            let isProcessing = false;
            let skippedFrames = 0;
            
            const captureInterval = setInterval(() => {
                if (!isMonitoring) {
                    clearInterval(captureInterval);
                    stream.getTracks().forEach(track => track.stop());
                    console.log('ğŸ“· æ”å½±æ©Ÿå·²åœæ­¢');
                    return;
                }
                
                if (isProcessing) {
                    skippedFrames++;
                    if (skippedFrames % 10 === 0) {
                        console.log(`â­ï¸ å·²è·³é ${skippedFrames} å¹€`);
                    }
                    return;
                }
                
                isProcessing = true;
                
                try {
                    // é¡¯ç¤ºå³æ™‚å½±åƒ
                    displayCtx.drawImage(video, 0, 0, 640, 480);
                    
                    // ç¹ªè£½åµæ¸¬æ¡†
                    if (latestDetection && latestDetection.boxes) {
                        drawBoundingBoxes(displayCtx, latestDetection.boxes);
                    }
                    
                    // ç™¼é€åˆ°ä¼ºæœå™¨
                    captureCtx.drawImage(video, 0, 0, 640, 480);
                    
                    captureCanvas.toBlob((blob) => {
                        if (!blob) {
                            isProcessing = false;
                            return;
                        }
                        
                        const reader = new FileReader();
                        
                        reader.onerror = () => {
                            console.error('âŒ FileReader éŒ¯èª¤');
                            isProcessing = false;
                        };
                        
                        reader.onloadend = () => {
                            try {
                                const base64data = reader.result.split(',')[1];
                                
                                if (websocket && websocket.readyState === WebSocket.OPEN) {
                                    websocket.send(JSON.stringify({
                                        type: "frame",
                                        data: base64data,
                                        timestamp: new Date().toISOString()
                                    }));
                                    
                                    frameCount++;
                                    document.getElementById('frameCount').textContent = frameCount;
                                    
                                    if (skippedFrames > 0) {
                                        skippedFrames = 0;
                                    }
                                } else {
                                    console.warn('âš ï¸ WebSocket æœªé€£ç·š');
                                }
                            } catch (error) {
                                console.error('âŒ ç™¼é€å¹€éŒ¯èª¤:', error);
                            } finally {
                                isProcessing = false;
                            }
                        };
                        
                        reader.readAsDataURL(blob);
                    }, 'image/jpeg', 0.8);
                    
                } catch (error) {
                    console.error('âŒ æ•æ‰å¹€éŒ¯èª¤:', error);
                    isProcessing = false;
                }
                
            }, 100); // 10 FPS
            
        } catch (error) {
            console.error('âŒ ç„¡æ³•å­˜å–æ”å½±æ©Ÿ:', error);
            
            let errorMsg = 'ç„¡æ³•å­˜å–æ”å½±æ©Ÿ\n\n';
            
            if (error.name === 'NotAllowedError') {
                errorMsg += 'åŸå› ï¼šæ¬Šé™è¢«æ‹’çµ•\nè«‹åœ¨ç€è¦½å™¨è¨­å®šä¸­å…è¨±æ”å½±æ©Ÿæ¬Šé™';
            } else if (error.name === 'NotFoundError') {
                errorMsg += 'åŸå› ï¼šæ‰¾ä¸åˆ°æ”å½±æ©Ÿ\nè«‹ç¢ºèªæ”å½±æ©Ÿå·²æ­£ç¢ºé€£æ¥';
            } else if (error.name === 'OverconstrainedError') {
                errorMsg += 'åŸå› ï¼šæŒ‡å®šçš„æ”å½±æ©Ÿä¸å¯ç”¨\nè©²è£ç½®å¯èƒ½å·²è¢«ç§»é™¤æˆ–æ­£è¢«å…¶ä»–ç¨‹å¼ä½¿ç”¨\n\nè«‹å˜—è©¦ï¼š\n1. é‡æ–°æƒææ”å½±æ©Ÿ\n2. åœ¨æ”å½±æ©Ÿç®¡ç†ä¸­æ›´æ–°æ­¤æ”å½±æ©Ÿ';
            } else if (error.name === 'NotReadableError') {
                errorMsg += 'åŸå› ï¼šæ”å½±æ©Ÿæ­£è¢«å…¶ä»–ç¨‹å¼ä½¿ç”¨\nè«‹é—œé–‰å…¶ä»–ä½¿ç”¨æ”å½±æ©Ÿçš„ç¨‹å¼';
            } else {
                errorMsg += 'éŒ¯èª¤: ' + error.message;
            }
            
            alert(errorMsg);
            stopMonitoring();
        }
    }
    
    // ğŸ”¥ ç¹ªè£½åµæ¸¬æ¡†
    function drawBoundingBoxes(ctx, boxes) {
        boxes.forEach(box => {
            const { x1, y1, x2, y2, confidence, label } = box;
            
            const color = label === 'person' ? '#00ff00' : '#ff0000';
            
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
            
            ctx.fillStyle = color;
            const text = `${label} ${(confidence * 100).toFixed(0)}%`;
            const textWidth = ctx.measureText(text).width;
            ctx.fillRect(x1, y1 - 25, textWidth + 10, 25);
            
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 16px Arial';
            ctx.fillText(text, x1 + 5, y1 - 7);
        });
    }
    
    // ğŸ”¥ è™•ç†ä¼ºæœå™¨è¨Šæ¯
    function handleServerMessage(data) {
        console.log('ğŸ“¨ æ”¶åˆ°è¨Šæ¯:', data.type);
        
        try {
            const detectionData = data.data || data;
            
            if (detectionData.boxes) {
                latestDetection = detectionData;
            }
            
            if (detectionData.is_smoking === true) {
                console.log('âš ï¸ åµæ¸¬åˆ°å¸è¸!');
                detectionCount++;
                document.getElementById('detectionCount').textContent = detectionCount;
                
                // æ–°å¢åˆ°æœ€è¿‘åµæ¸¬
                addRecentDetection(detectionData);
                
                // é¡¯ç¤ºè­¦å ±
                const alert = document.getElementById('detectionAlert');
                if (alert) {
                    alert.style.display = 'block';
                    setTimeout(() => {
                        alert.style.display = 'none';
                    }, 3000);
                }
            }
            
            // æ›´æ–°ä¿¡å¿ƒåº¦
            const alpha = 0.2;
            if (detectionData.max_confidence !== undefined) {
                const confPercent = detectionData.max_confidence * 100;
                avgConfidence = avgConfidence ? (alpha * confPercent + (1-alpha) * avgConfidence) : confPercent;
                document.getElementById('avgConfidence').textContent = avgConfidence.toFixed(1) + '%';
            }
            
        } catch (error) {
            console.error('âŒ handleServerMessage éŒ¯èª¤:', error);
        }
    }
    
    // ğŸ”¥ æ–°å¢æœ€è¿‘åµæ¸¬è¨˜éŒ„
    function addRecentDetection(data) {
        try {
            const container = document.getElementById('recentDetections');
            if (!container) return;
            
            if (container.querySelector('.text-center')) {
                container.innerHTML = '';
            }
            
            const item = document.createElement('div');
            item.className = 'list-group-item';
            const confidence = data.max_confidence || data.confidence || 0;
            item.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-exclamation-triangle text-danger"></i>
                        <strong>å¸è¸åµæ¸¬</strong><br>
                        <small class="text-muted">${new Date().toLocaleTimeString('zh-TW')}</small>
                    </div>
                    <span class="badge bg-danger">${(confidence * 100).toFixed(1)}%</span>
                </div>
            `;
            
            container.prepend(item);
            
            while (container.children.length > 10) {
                container.removeChild(container.lastChild);
            }
        } catch (error) {
            console.error('âŒ addRecentDetection éŒ¯èª¤:', error);
        }
    }
    
    // ğŸ”¥ åœæ­¢ç›£æ§
    function stopMonitoring() {
        isMonitoring = false;
        
        if (websocket) {
            websocket.close();
            websocket = null;
        }
        
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
        
        updateStatus('offline');
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
        document.getElementById('videoPlaceholder').style.display = 'flex';
        document.getElementById('displayCanvas').style.display = 'none';
        
        stopFpsCounter();
        latestDetection = null;
        
        console.log('â¹ï¸ ç›£æ§å·²åœæ­¢');
    }
    
    // ğŸ”¥ æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºå™¨
    function updateStatus(status) {
        const indicator = document.getElementById('statusIndicator');
        indicator.className = 'status-indicator';
        
        if (status === 'online') {
            indicator.classList.add('status-online');
            indicator.innerHTML = '<i class="bi bi-wifi"></i> ç·šä¸Š';
        } else if (status === 'connecting') {
            indicator.classList.add('status-connecting');
            indicator.innerHTML = '<i class="bi bi-hourglass-split"></i> é€£ç·šä¸­';
        } else {
            indicator.classList.add('status-offline');
            indicator.innerHTML = '<i class="bi bi-wifi-off"></i> é›¢ç·š';
        }
    }
    
    // ğŸ”¥ FPS è¨ˆæ•¸å™¨
    function startFpsCounter() {
        let lastFrame = frameCount;
        fpsInterval = setInterval(() => {
            const fps = frameCount - lastFrame;
            document.getElementById('fpsCounter').textContent = `FPS: ${fps}`;
            lastFrame = frameCount;
        }, 1000);
    }
    
    function stopFpsCounter() {
        if (fpsInterval) {
            clearInterval(fpsInterval);
            document.getElementById('fpsCounter').textContent = 'FPS: 0';
        }
    }
    
    // ğŸ”¥ æˆªåœ–åŠŸèƒ½
    function takeScreenshot() {
        const canvas = document.getElementById('displayCanvas');
        if (canvas.style.display === 'block') {
            const link = document.createElement('a');
            link.download = `screenshot_${Date.now()}.jpg`;
            link.href = canvas.toDataURL('image/jpeg');
            link.click();
        } else {
            alert('è«‹å…ˆé–‹å§‹ç›£æ§');
        }
    }
    
    // ğŸ”¥ é€šçŸ¥å‡½æ•¸
    function showNotification(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 3000);
    }
    
    // ğŸ”¥ ç™»å‡º
    function logout() {
        stopMonitoring();
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = 'login.html';
    }
    
    // ğŸ”¥ å‹•æ…‹å°è¦½åˆ—
    function toggleSidebar() {
        const sidebar = document.querySelector('.sidebar');
        const mainContent = document.querySelector('.main-content');
        const toggleBtn = document.querySelector('.toggle-btn');

        sidebar.classList.toggle('collapsed');
        mainContent.classList.toggle('collapsed');
        toggleBtn.classList.toggle('collapsed');
    }
    
    // åˆå§‹è¼‰å…¥
    loadCameras();
    
    // é é¢é—œé–‰è­¦å‘Š
    window.addEventListener('beforeunload', (e) => {
        if (isMonitoring) {
            console.log('âš ï¸ é é¢å³å°‡é—œé–‰');
        }
    });
</script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>