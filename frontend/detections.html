<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>偵測記錄 - 吸菸監控系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="./css/detections.css">
    <style>   
    </style>
</head>
<body>
    <!--收縮側邊欄按鈕-->
    <div class="toggle-btn" onclick="toggleSidebar()">
        <i class="bi bi-list"></i>
    </div>

    <!-- 側邊欄 -->
    <div class="sidebar">
        <div class="logo">
            <i class="bi bi-camera-video-off"></i>
            <h5 class="mt-2 logo-text">吸菸監控系統</h5>
        </div>
        
        <nav class="nav flex-column">
            <a class="nav-link" href="dashboard.html">
                <i class="bi bi-speedometer2"></i> 儀表板
            </a>
            <a class="nav-link" href="cameras.html">
                <i class="bi bi-camera"></i> 攝影機管理
            </a>
            <a class="nav-link" href="monitor.html">
                <i class="bi bi-display"></i> 即時監控
            </a>
            <a class="nav-link active" href="detections.html">
                <i class="bi bi-list-ul"></i> 偵測記錄
            </a>
            <a class="nav-link" href="settings.html">
                <i class="bi bi-gear"></i> 系統設定
            </a>
            <a class="nav-link" href="#" onclick="logout()">
                <i class="bi bi-box-arrow-right"></i> 登出
            </a>
        </nav>
    </div>
    
    <!-- 主要內容 -->
    <div class="main-content">
        <h2 class="mb-4"><i class="bi bi-list-ul"></i> 偵測記錄</h2>
        
        <!-- 篩選區 -->
        <div class="filter-section">
            <div class="row g-3">
                <div class="col-md-3">
            <label class="form-label">開始日期</label>
            <input type="date" class="form-control" id="filterStartDate" onchange="loadDetections()">
            </div>

            <div class="col-md-3">
                <label class="form-label">結束日期</label>
                <input type="date" class="form-control" id="filterEndDate" onchange="loadDetections()">
            </div>

                <div class="col-md-4">
                    <label class="form-label">攝影機</label>
                    <select class="form-select" id="filterCamera" onchange="loadDetections()">
                        <option value="">全部攝影機</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label class="form-label">顯示數量</label>
                    <select class="form-select" id="filterLimit" onchange="loadDetections()">
                        <option value="20">20 筆</option>
                        <option value="50" selected>50 筆</option>
                        <option value="100">100 筆</option>
                        <option value="200">200 筆</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label class="form-label">狀態</label>
                    <select class="form-select" id="filterStatus">
                        <option value="all">全部</option>
                        <option value="smoking">僅顯示吸菸</option>
                    </select>
                </div>
                
                <div class="col-md-2 d-flex align-items-end">
                    
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-primary flex-fill text-nowrap" style="font-size: 16px; padding: 0.5rem 1rem;" onclick="loadDetections()">
                            <i class="bi bi-search"></i> 查詢
                        </button>

                        <button class="btn btn-success flex-fill text-nowrap" style="font-size: 16px; padding: 0.5rem 1rem;" onclick="exportExcel()">
                            <i class="bi bi-download"></i> 匯出報表(.xlsx)
                        </button>
                    </div>


                </div>
            </div>
        </div>
        
        <!-- 記錄表格 -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>時間</th>
                                <th>攝影機</th>
                                <th>位置</th>
                                <th>偵測到人</th>
                                <th>偵測到香菸</th>
                                <th>信心度</th>
                                <th>狀態</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="detectionsTable">
                            <tr>
                                <td colspan="9" class="text-center text-muted">載入中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div id="noData" class="text-center py-5" style="display: none;">
                    <i class="bi bi-inbox" style="font-size: 60px; color: #ccc;"></i>
                    <p class="text-muted mt-3">目前沒有偵測記錄</p>
                </div>
            </div>
        </div>
    </div>
    <!-- 截圖預覽 Modal -->
    <div class="modal fade" id="screenshotModal" tabindex="-1" aria-labelledby="screenshotModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="screenshotModalLabel">截圖預覽</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
            <img id="screenshotImage" src="" alt="Screenshot" style="max-width:100%; max-height:70vh; border-radius:8px; border:1px solid #dee2e6; box-shadow:0 4px 8px rgba(0,0,0,0.1);" />
        </div>
        <div class="modal-footer justify-content-center">
            <a id="downloadScreenshot" href="#" download="" class="btn btn-primary">下載圖片</a>
        </div>
        </div>
    </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        
        if (!token) {
            window.location.href = 'login.html';
        }
        
        // 載入攝影機列表(用於篩選)
        async function loadCameras() {
            try {
                const response = await fetch(`${API_URL}/api/cameras`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const cameras = await response.json();
                const select = document.getElementById('filterCamera');
                
                cameras.forEach(camera => {
                    const option = document.createElement('option');
                    option.value = camera.id;
                    option.textContent = camera.camera_name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading cameras:', error);
            }
        }
        
        // 載入偵測記錄
        async function loadDetections() {
            const cameraId = document.getElementById('filterCamera').value;
            const limit = document.getElementById('filterLimit').value;
            const status = document.getElementById('filterStatus').value;
            
            let url = `${API_URL}/api/detections?limit=${limit}`;
            if (cameraId) {
                url += `&camera_id=${cameraId}`;
            }
            // 取得日期
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;

            // 加入到 URL
            if (startDate) {
                url += `&start_date=${startDate}`;
            }
            if (endDate) {
                url += `&end_date=${endDate}`;
            }
            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                let detections = await response.json();
                
                // 篩選狀態
                if (status === 'smoking') {
                    detections = detections.filter(d => d.is_smoking);
                }
                
                displayDetections(detections);
            } catch (error) {
                console.error('Error loading detections:', error);
            }
        }
        
        function displayDetections(detections) {
            const tbody = document.getElementById('detectionsTable');
            const noData = document.getElementById('noData');
            
            if (detections.length === 0) {
                tbody.innerHTML = '';
                noData.style.display = 'block';
                return;
            }
            
            noData.style.display = 'none';
            
            tbody.innerHTML = detections.map(d => `
                <tr>
                    <td>${d.id}</td>
                    <td>${new Date(d.timestamp).toLocaleString('zh-TW')}</td>
                    <td><i class="bi bi-camera"></i> ${d.camera_name}</td>
                    <td>${d.location || '-'}</td>
                    <td>
                        <span class="badge ${d.has_person ? 'bg-success' : 'bg-secondary'}">
                            ${d.has_person ? '是' : '否'}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${d.has_cigarette ? 'bg-warning' : 'bg-secondary'}">
                            ${d.has_cigarette ? '是' : '否'}
                        </span>
                    </td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar ${d.confidence > 0.8 ? 'bg-success' : d.confidence > 0.6 ? 'bg-warning' : 'bg-danger'}" 
                                 style="width: ${d.confidence * 100}%">
                                ${(d.confidence * 100).toFixed(1)}%
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge ${d.is_smoking ? 'bg-danger' : 'bg-success'}">
                            ${d.is_smoking ? '⚠️ 偵測到吸菸' : '✓ 正常'}
                        </span>
                    </td>
                    <td>
                        ${d.screenshot_path ? `
                            <button class="btn btn-sm btn-outline-primary" onclick="viewScreenshot('${d.screenshot_path}')">
                                <i class="bi bi-image"></i> 查看
                            </button>
                        ` : '-'}
                    </td>
                </tr>
            `).join('');
        }
        

        //不能使用滑鼠縮放照片
        // function viewScreenshot(filename) {
        //     if (!filename) return;

        //     const url = `/api/screenshots/${encodeURIComponent(filename)}`;

        //     // 設定 Modal 的圖片
        //     const img = document.getElementById('screenshotImage');
        //     img.src = url;

        //     // 設定下載連結
        //     const downloadLink = document.getElementById('downloadScreenshot');
        //     downloadLink.href = url;
        //     downloadLink.download = filename;

        //     // 顯示 Modal
        //     const screenshotModal = new bootstrap.Modal(document.getElementById('screenshotModal'));
        //     screenshotModal.show();
        // }


            function viewScreenshot(filename) {
        if (!filename) return;

        const url = `/api/screenshots/${encodeURIComponent(filename)}`;

        // 設定 Modal 的圖片
        const img = document.getElementById('screenshotImage');
        img.src = url;

        // 初始化縮放比例
        img.style.transform = "scale(1)";
        let scale = 1;

        // 監聽滾輪事件
        img.onwheel = function(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1; // 向上滾放大，向下滾縮小
            scale = Math.min(Math.max(0.5, scale + delta), 3); // 限制縮放範圍 0.5x ~ 3x
            img.style.transform = `scale(${scale})`;
        };

        // 設定下載連結
        const downloadLink = document.getElementById('downloadScreenshot');
        downloadLink.href = url;
        downloadLink.download = filename;

        // 顯示 Modal
        const screenshotModal = new bootstrap.Modal(document.getElementById('screenshotModal'));
        screenshotModal.show();
    }
        function logout() {
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = 'login.html';
        }
        //動態導覽列
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleBtn = document.querySelector('.toggle-btn');

            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('collapsed');
            toggleBtn.classList.toggle('collapsed');
        }
        //匯出報表(.xlsx)
        function exportExcel() {
            const tbody = document.getElementById('detectionsTable');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            if (rows.length === 0) {
                alert('目前沒有資料可匯出');
                return;
            }

            const data = [];
            // 加入表頭
            data.push(["ID","時間","攝影機","位置","偵測到人","偵測到香菸","信心度","狀態","操作"]);

            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll('td'));
                if (cells.length === 1 && cells[0].colSpan === 9) return; // 跳過 "載入中..." 或沒有資料

                const rowData = cells.map((cell, idx) => {
                    if (idx === 8) { // 操作欄，只取圖片路徑
                        const btn = cell.querySelector('button');
                        return btn ? btn.getAttribute('onclick').match(/'(.+?)'/)[1] : '';
                    }

                    if (idx === 6) { // 信心度，抓百分比
                        const progress = cell.querySelector('.progress-bar');
                        return progress ? progress.textContent.trim() : cell.textContent.trim();
                    }

                    if (idx === 4 || idx === 5 || idx === 7) { // Badge 狀態欄
                        return cell.textContent.trim();
                    }

                    return cell.textContent.trim();
                });

                data.push(rowData);
            });

            // 建立工作表
            const ws = XLSX.utils.aoa_to_sheet(data);

            // 套簡單樣式：信心度顏色 & 狀態顏色
            rows.forEach((row, i) => {
                const cells = Array.from(row.querySelectorAll('td'));
                if (cells.length === 1 && cells[0].colSpan === 9) return;
                // 信心度 (欄位 7)
                const progress = cells[6].querySelector('.progress-bar');
                if (progress) {
                    const color = progress.classList.contains('bg-success') ? 'green' :
                                progress.classList.contains('bg-warning') ? 'orange' :
                                'red';
                    const cellRef = XLSX.utils.encode_cell({r: i+1, c:6});
                    if (!ws[cellRef]) ws[cellRef] = { t:'s', v: data[i+1][6] };
                    ws[cellRef].s = { fill: { fgColor: { rgb: color.replace('#','') } } };
                }
                // 狀態 (欄位 8)
                const status = cells[7].querySelector('.badge');
                if (status) {
                    const color = status.classList.contains('bg-success') ? 'green' : 'red';
                    const cellRef = XLSX.utils.encode_cell({r: i+1, c:7});
                    if (!ws[cellRef]) ws[cellRef] = { t:'s', v: data[i+1][7] };
                    ws[cellRef].s = { fill: { fgColor: { rgb: color.replace('#','') } } };
                }
            });

            // 建立工作簿並匯出
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "偵測紀錄");
            XLSX.writeFile(wb, `detections_report_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        // 初始載入
        loadCameras();
        loadDetections();

    </script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>