<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚ç›£æ§ - å¸è¸ç›£æ§ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            background: #f8f9fa;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 250px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .sidebar .logo {
            text-align: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }
        
        .sidebar .logo i {
            font-size: 40px;
        }
        
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 15px 30px;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .sidebar .nav-link i {
            margin-right: 10px;
            font-size: 18px;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 30px;
        }
        
        .card {
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            border: none;
        }
        
        .video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .video-placeholder {
            text-align: center;
            color: #6c757d;
        }
        
        .video-placeholder i {
            font-size: 80px;
            margin-bottom: 20px;
        }
        
        #displayCanvas {
            width: 100%;
            height: auto;
            display: none;
        }
        
        .status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .status-connecting {
            background: #ffc107;
            color: #000;
        }
        
        .status-online {
            background: #28a745;
            color: white;
        }
        
        .status-offline {
            background: #dc3545;
            color: white;
        }
        
        .detection-alert {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background: rgba(220, 53, 69, 0.95);
            color: white;
            border-radius: 10px;
            font-weight: bold;
            display: none;
            animation: pulse 1s infinite;
            z-index: 10;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }
        
        .camera-select-card {
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .camera-select-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .camera-select-card.selected {
            border-color: #667eea;
            background: #f0f3ff;
        }
        
        .stats-box {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .stats-box h4 {
            margin: 0;
            color: #667eea;
        }
        
        .stats-box p {
            margin: 5px 0 0 0;
            color: #6c757d;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- å´é‚Šæ¬„ -->
    <div class="sidebar">
        <div class="logo">
            <i class="bi bi-camera-video-off"></i>
            <h5 class="mt-2">å¸è¸ç›£æ§ç³»çµ±</h5>
        </div>
        
        <nav class="nav flex-column">
            <a class="nav-link" href="dashboard.html">
                <i class="bi bi-speedometer2"></i> å„€è¡¨æ¿
            </a>
            <a class="nav-link" href="cameras.html">
                <i class="bi bi-camera"></i> æ”å½±æ©Ÿç®¡ç†
            </a>
            <a class="nav-link active" href="monitor.html">
                <i class="bi bi-display"></i> å³æ™‚ç›£æ§
            </a>
            <a class="nav-link" href="detections.html">
                <i class="bi bi-list-ul"></i> åµæ¸¬è¨˜éŒ„
            </a>
            <a class="nav-link" href="settings.html">
                <i class="bi bi-gear"></i> ç³»çµ±è¨­å®š
            </a>
            <a class="nav-link" href="#" onclick="logout()">
                <i class="bi bi-box-arrow-right"></i> ç™»å‡º
            </a>
        </nav>
    </div>
    
    <!-- ä¸»è¦å…§å®¹ -->
    <div class="main-content">
        <h2 class="mb-4"><i class="bi bi-display"></i> å³æ™‚ç›£æ§</h2>
        
        <!-- æ”å½±æ©Ÿé¸æ“‡ -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3"><i class="bi bi-camera"></i> é¸æ“‡æ”å½±æ©Ÿ</h5>
                <div id="cameraSelector" class="row g-3">
                    <div class="col-12 text-center text-muted">
                        è¼‰å…¥ä¸­...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è¦–è¨Šç•«é¢ -->
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-body p-0">
                        <div class="video-container">
                            <div id="videoPlaceholder" class="video-placeholder">
                                <i class="bi bi-camera-video-off"></i>
                                <p>è«‹é¸æ“‡æ”å½±æ©Ÿé–‹å§‹ç›£æ§</p>
                            </div>
                            <canvas id="displayCanvas"></canvas>
                            <div id="statusIndicator" class="status-indicator status-offline">
                                <i class="bi bi-wifi-off"></i> é›¢ç·š
                            </div>
                            <div id="detectionAlert" class="detection-alert">
                                <i class="bi bi-exclamation-triangle"></i> åµæ¸¬åˆ°å¸è¸è¡Œç‚ºï¼
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ§åˆ¶é¢æ¿ -->
                <div class="control-panel">
                    <div class="row g-3 align-items-center">
                        <div class="col-auto">
                            <button id="startBtn" class="btn btn-success" onclick="startMonitoring()" disabled>
                                <i class="bi bi-play-fill"></i> é–‹å§‹ç›£æ§
                            </button>
                        </div>
                        <div class="col-auto">
                            <button id="stopBtn" class="btn btn-danger" onclick="stopMonitoring()" disabled>
                                <i class="bi bi-stop-fill"></i> åœæ­¢ç›£æ§
                            </button>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-outline-secondary" onclick="takeScreenshot()">
                                <i class="bi bi-camera"></i> æˆªåœ–
                            </button>
                        </div>
                        <div class="col-auto ms-auto">
                            <span id="fpsCounter" class="text-muted">FPS: 0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- çµ±è¨ˆè³‡è¨Š -->
            <div class="col-lg-4">
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title mb-3"><i class="bi bi-graph-up"></i> å³æ™‚çµ±è¨ˆ</h5>
                        
                        <div class="stats-box mb-3">
                            <h4 id="frameCount">0</h4>
                            <p>å·²è™•ç†å¹€æ•¸</p>
                        </div>
                        
                        <div class="stats-box mb-3">
                            <h4 id="detectionCount">0</h4>
                            <p>åµæ¸¬æ¬¡æ•¸</p>
                        </div>
                        
                        <div class="stats-box">
                            <h4 id="avgConfidence">0%</h4>
                            <p>å¹³å‡ä¿¡å¿ƒåº¦</p>
                        </div>
                    </div>
                </div>
                
                <!-- æœ€è¿‘åµæ¸¬ -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3"><i class="bi bi-clock-history"></i> æœ€è¿‘åµæ¸¬</h5>
                        <div id="recentDetections" class="list-group list-group-flush">
                            <div class="text-center text-muted py-3">
                                å°šç„¡åµæ¸¬è¨˜éŒ„
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        if (window.LiveReloadOptions) {
            window.LiveReloadOptions.enabled = false;
        }
        const API_URL = 'http://localhost:8000';
        const WS_URL = 'ws://localhost:8000';
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        
        if (!token) {
            window.location.href = 'login.html';
        }
        
        let selectedCamera = null;
        let websocket = null;
        let isMonitoring = false;
        let frameCount = 0;
        let detectionCount = 0;
        let totalConfidence = 0;
        let fpsInterval;
        let latestDetection = null;
        let videoStream = null;
        
        // è¼‰å…¥æ”å½±æ©Ÿåˆ—è¡¨
        async function loadCameras() {
            try {
                const response = await fetch(`${API_URL}/api/cameras`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const cameras = await response.json();
                displayCameras(cameras);
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        function displayCameras(cameras) {
            const container = document.getElementById('cameraSelector');
            
            if (cameras.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center">
                        <p class="text-muted">æ²’æœ‰å¯ç”¨çš„æ”å½±æ©Ÿ</p>
                        <a href="cameras.html" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> æ–°å¢æ”å½±æ©Ÿ
                        </a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = cameras.map(camera => `
                <div class="col-md-6 col-lg-4">
                    <div class="card camera-select-card" onclick="selectCamera(${camera.id}, '${camera.camera_name}', '${camera.api_key}')">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="bi bi-camera"></i> ${camera.camera_name}
                            </h6>
                            <p class="card-text mb-2">
                                <small class="text-muted">
                                    <i class="bi bi-tag"></i> ${camera.camera_type.toUpperCase()}<br>
                                    <i class="bi bi-geo-alt"></i> ${camera.location || 'æœªè¨­å®š'}
                                </small>
                            </p>
                            <span class="badge ${camera.is_online ? 'bg-success' : 'bg-secondary'}">
                                ${camera.is_online ? 'ç·šä¸Š' : 'é›¢ç·š'}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function selectCamera(id, name, apiKey) {
            document.querySelectorAll('.camera-select-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            event.currentTarget.classList.add('selected');
            
            selectedCamera = { id, name, apiKey };
            document.getElementById('startBtn').disabled = false;
            
            console.log('å·²é¸æ“‡æ”å½±æ©Ÿ:', name);
        }
        
        async function startMonitoring() {
            if (!selectedCamera) {
                alert('è«‹å…ˆé¸æ“‡æ”å½±æ©Ÿ');
                return;
            }
            
            if (isMonitoring) {
                alert("ç›£æ¸¬ä¸­");
                return;

            }
            
            try {
                const wsUrl = `${WS_URL}/ws/upload/${selectedCamera.apiKey}`;
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = () => {
                    console.log('âœ… WebSocket å·²é€£ç·š');
                    isMonitoring = true;
                    updateStatus('online');
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    document.getElementById('videoPlaceholder').style.display = 'none';
                    document.getElementById('displayCanvas').style.display = 'block';
                    startFpsCounter();
                };
                
                // websocket.onmessage = async (event) => {
                //     try {
                //         const data = JSON.parse(event.data);
                //         console.log('ğŸ” æ”¶åˆ°åµæ¸¬çµæœ:', data);
                //         handleServerMessage(data);
                //     } catch (error) {
                //         console.error('è™•ç†è¨Šæ¯éŒ¯èª¤:', error);
                //     }
                // };

                websocket.onmessage = async (event) => {
                    console.log('ğŸ“¨ æ”¶åˆ°åŸå§‹è¨Šæ¯');
                    
                    let data;
                    try {
                        data = JSON.parse(event.data);
                        console.log('âœ… JSON è§£ææˆåŠŸ:', data);
                    } catch (error) {
                        console.error('âŒ JSON è§£æå¤±æ•—:', error);
                        console.error('åŸå§‹è³‡æ–™:', event.data);
                        return; // ç›´æ¥è¿”å›,ä¸è™•ç†
                    }
                    
                    console.log('ğŸ” æ”¶åˆ°åµæ¸¬çµæœ:', data);
                    
                    try {
                        handleServerMessage(data);
                        console.log('âœ… handleServerMessage å®Œæˆ');
                    } catch (error) {
                        console.error('âŒ handleServerMessage éŒ¯èª¤:', error);
                        console.trace();
                        // ä¸è¦è®“éŒ¯èª¤å‚³æ’­
                    }
                };
                
                websocket.onerror = (error) => {
                    console.error('âŒ WebSocket éŒ¯èª¤:', error);

                };
                
                websocket.onclose = () => {
                    console.log('âš ï¸ WebSocket å·²æ–·ç·š');
                    
                    if (isMonitoring) {
                        // ä¸è¦è‡ªå‹•åœæ­¢,ä¿æŒç›£æ§ç‹€æ…‹
                        console.log('é€£ç·šä¸­æ–·,å˜—è©¦ç¶­æŒæœ¬åœ°é¡¯ç¤º');
                        
                    }
                };
                
                await startVideoCapture();
                
            } catch (error) {
                console.error('å•Ÿå‹•ç›£æ§å¤±æ•—:', error);
                alert('å•Ÿå‹•ç›£æ§å¤±æ•—');
            }
        }
        
        // async function startVideoCapture() {
        //     try {
        //         const stream = await navigator.mediaDevices.getUserMedia({ 
        //             video: { width: 640, height: 480 } 
        //         });
                
        //         videoStream = stream;
        //         const video = document.createElement('video');
        //         video.srcObject = stream;
        //         video.play();
                
        //         const captureCanvas = document.createElement('canvas');
        //         captureCanvas.width = 640;
        //         captureCanvas.height = 480;
        //         const captureCtx = captureCanvas.getContext('2d');
                
        //         const displayCanvas = document.getElementById('displayCanvas');
        //         displayCanvas.width = 640;
        //         displayCanvas.height = 480;
        //         const displayCtx = displayCanvas.getContext('2d');
                
        //         const captureInterval = setInterval(() => {
        //             if (!isMonitoring) {
        //                 clearInterval(captureInterval);
        //                 stream.getTracks().forEach(track => track.stop());
        //                 return;
        //             }
                    
        //             // ç¹ªè£½å½±åƒåˆ°é¡¯ç¤º canvas
        //             displayCtx.drawImage(video, 0, 0, 640, 480);
                    
        //             // ç¹ªè£½ bounding boxes
        //             if (latestDetection && latestDetection.boxes) {
        //                 drawBoundingBoxes(displayCtx, latestDetection.boxes);
        //             }
                    
        //             // ç™¼é€åˆ°ä¼ºæœå™¨
        //             captureCtx.drawImage(video, 0, 0, 640, 480);
        //             captureCanvas.toBlob((blob) => {
        //                 const reader = new FileReader();
        //                 reader.onloadend = () => {
        //                     const base64data = reader.result.split(',')[1];
                            
        //                     if (websocket && websocket.readyState === WebSocket.OPEN) {
        //                         websocket.send(JSON.stringify({
        //                             type: "frame",
        //                             data: base64data,
        //                             timestamp: new Date().toISOString()
        //                         }));
                                
        //                         frameCount++;
        //                         document.getElementById('frameCount').textContent = frameCount;
        //                     }
        //                 };
        //                 reader.readAsDataURL(blob);
        //             }, 'image/jpeg', 0.8);
                    
        //         }, 100);
                
        //     } catch (error) {
        //         console.error('ç„¡æ³•å­˜å–æ”å½±æ©Ÿ:', error);
        //         alert('ç„¡æ³•å­˜å–æ”å½±æ©Ÿ,è«‹ç¢ºèªæ¬Šé™è¨­å®š');
        //         stopMonitoring();
        //     }
        // }
// ä¿®æ­£å¾Œçš„ startVideoCapture - åŠ å…¥è™•ç†é–å®šæ©Ÿåˆ¶

        async function startVideoCapture() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 } 
                });
                
                videoStream = stream;
                const video = document.createElement('video');
                video.srcObject = stream;
                video.play();
                
                const captureCanvas = document.createElement('canvas');
                captureCanvas.width = 640;
                captureCanvas.height = 480;
                const captureCtx = captureCanvas.getContext('2d');
                
                const displayCanvas = document.getElementById('displayCanvas');
                displayCanvas.width = 640;
                displayCanvas.height = 480;
                const displayCtx = displayCanvas.getContext('2d');
                
                // âœ… åŠ å…¥è™•ç†ä¸­æ¨™è¨˜,é¿å…ä¸¦ç™¼å•é¡Œ
                let isProcessing = false;
                let skippedFrames = 0;
                
                const captureInterval = setInterval(() => {
                    if (!isMonitoring) {
                        clearInterval(captureInterval);
                        stream.getTracks().forEach(track => track.stop());
                        console.log('ğŸ“· æ”å½±æ©Ÿå·²åœæ­¢');
                        return;
                    }
                    
                    // âœ… å¦‚æœé‚„åœ¨è™•ç†ä¸Šä¸€å¹€,è·³éé€™æ¬¡
                    if (isProcessing) {
                        skippedFrames++;
                        if (skippedFrames % 10 === 0) {
                            console.log(`â­ï¸ å·²è·³é ${skippedFrames} å¹€ (è™•ç†é€Ÿåº¦è¼ƒæ…¢)`);
                        }
                        return;
                    }
                    
                    isProcessing = true;
                    
                    try {
                        // ç¹ªè£½å½±åƒåˆ°é¡¯ç¤º canvas
                        displayCtx.drawImage(video, 0, 0, 640, 480);
                        
                        // ç¹ªè£½ bounding boxes
                        if (latestDetection && latestDetection.boxes) {
                            try {
                                drawBoundingBoxes(displayCtx, latestDetection.boxes);
                            } catch (error) {
                                console.error('âŒ drawBoundingBoxes éŒ¯èª¤:', error);
                            }
                        }
                        
                        // ç™¼é€åˆ°ä¼ºæœå™¨
                        captureCtx.drawImage(video, 0, 0, 640, 480);
                        
                        captureCanvas.toBlob((blob) => {
                            if (!blob) {
                                console.error('âŒ toBlob å¤±æ•—');
                                isProcessing = false;
                                return;
                            }
                            
                            const reader = new FileReader();
                            
                            reader.onerror = () => {
                                console.error('âŒ FileReader éŒ¯èª¤');
                                isProcessing = false;
                            };
                            
                            reader.onloadend = () => {
                                try {
                                    const base64data = reader.result.split(',')[1];
                                    
                                    if (websocket && websocket.readyState === WebSocket.OPEN) {
                                        websocket.send(JSON.stringify({
                                            type: "frame",
                                            data: base64data,
                                            timestamp: new Date().toISOString()
                                        }));
                                        
                                        frameCount++;
                                        const countEl = document.getElementById('frameCount');
                                        if (countEl) {
                                            countEl.textContent = frameCount;
                                        }
                                        
                                        // é‡ç½®è·³éè¨ˆæ•¸
                                        if (skippedFrames > 0) {
                                            skippedFrames = 0;
                                        }
                                    } else {
                                        console.warn('âš ï¸ WebSocket æœªé€£ç·š,è·³éç™¼é€');
                                    }
                                } catch (error) {
                                    console.error('âŒ ç™¼é€å¹€éŒ¯èª¤:', error);
                                } finally {
                                    // âœ… ç¢ºä¿è§£é–
                                    isProcessing = false;
                                }
                            };
                            
                            reader.readAsDataURL(blob);
                        }, 'image/jpeg', 0.8);
                        
                    } catch (error) {
                        console.error('âŒ æ•æ‰å¹€éŒ¯èª¤:', error);
                        isProcessing = false;
                    }
                    
                }, 100); // æ¯ 100ms ä¸€æ¬¡ (æœ€å¤š 10 FPS)
                
            } catch (error) {
                console.error('âŒ ç„¡æ³•å­˜å–æ”å½±æ©Ÿ:', error);
                alert('ç„¡æ³•å­˜å–æ”å½±æ©Ÿ,è«‹ç¢ºèªæ¬Šé™è¨­å®š');
                stopMonitoring();
            }
        }       

           
        function drawBoundingBoxes(ctx, boxes) {
            boxes.forEach(box => {
                const { x1, y1, x2, y2, confidence, label } = box;
                
                // è¨­å®šé¡è‰² (äºº=ç¶ è‰², é¦™è¸=ç´…è‰²)
                const color = label === 'person' ? '#00ff00' : '#ff0000';
                
                // ç¹ªè£½æ¡†
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
                
                // ç¹ªè£½æ¨™ç±¤èƒŒæ™¯
                ctx.fillStyle = color;
                const text = `${label} ${(confidence * 100).toFixed(0)}%`;
                const textWidth = ctx.measureText(text).width;
                ctx.fillRect(x1, y1 - 25, textWidth + 10, 25);
                
                // ç¹ªè£½æ¨™ç±¤æ–‡å­—
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 16px Arial';
                ctx.fillText(text, x1 + 5, y1 - 7);
            });
        }
        
    
        function handleServerMessage(data) {
            console.log('ğŸ“¨ æ”¶åˆ°è¨Šæ¯:', data.type);
            
            try {
                const detectionData = data.data || data;
                
                // åªæ›´æ–° bounding boxes
                if (detectionData.boxes) {
                    latestDetection = detectionData;
                    console.log('âœ… æ¡†æ¡†æ•¸é‡:', detectionData.boxes.length);
                }
                
                // æ›´æ–°ä¿¡å¿ƒåº¦
                if (detectionData.max_confidence !== undefined) {
                    totalConfidence += detectionData.max_confidence;
                    const avgConf = (totalConfidence / frameCount * 100).toFixed(1);
                    document.getElementById('avgConfidence').textContent = avgConf + '%';
                }
                
                console.log('âœ… å®Œæˆ');
            } catch (error) {
                console.error('âŒ éŒ¯èª¤:', error);
            }
        }
        
        function addRecentDetection(data) {
            try {
                const container = document.getElementById('recentDetections');
                if (!container) {
                    console.error('æ‰¾ä¸åˆ° recentDetections å…ƒç´ ');
                    return;
                }
                
                if (container.querySelector('.text-center')) {
                    container.innerHTML = '';
                }
                
                const item = document.createElement('div');
                item.className = 'list-group-item';
                const confidence = data.max_confidence || data.confidence || 0;
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-exclamation-triangle text-danger"></i>
                            <strong>å¸è¸åµæ¸¬</strong><br>
                            <small class="text-muted">${new Date().toLocaleTimeString('zh-TW')}</small>
                        </div>
                        <span class="badge bg-danger">${(confidence * 100).toFixed(1)}%</span>
                    </div>
                `;
                
                container.prepend(item);
                
                while (container.children.length > 10) {
                    container.removeChild(container.lastChild);
                }
            } catch (error) {
                console.error('âŒ addRecentDetection éŒ¯èª¤:', error);
            }
        }

        function stopMonitoring() {
            isMonitoring = false;
            
            if (websocket) {
                websocket.close();
                websocket = null;
            }
            
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            updateStatus('offline');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('videoPlaceholder').style.display = 'flex';
            document.getElementById('displayCanvas').style.display = 'none';
            
            stopFpsCounter();
            latestDetection = null;
        }
        
        function updateStatus(status) {
            const indicator = document.getElementById('statusIndicator');
            indicator.className = 'status-indicator';
            
            if (status === 'online') {
                indicator.classList.add('status-online');
                indicator.innerHTML = '<i class="bi bi-wifi"></i> ç·šä¸Š';
            } else if (status === 'connecting') {
                indicator.classList.add('status-connecting');
                indicator.innerHTML = '<i class="bi bi-hourglass-split"></i> é€£ç·šä¸­';
            } else {
                indicator.classList.add('status-offline');
                indicator.innerHTML = '<i class="bi bi-wifi-off"></i> é›¢ç·š';
            }
        }
        
        function startFpsCounter() {
            let lastFrame = frameCount;
            fpsInterval = setInterval(() => {
                const fps = frameCount - lastFrame;
                document.getElementById('fpsCounter').textContent = `FPS: ${fps}`;
                lastFrame = frameCount;
            }, 1000);
        }
        
        function stopFpsCounter() {
            if (fpsInterval) {
                clearInterval(fpsInterval);
                document.getElementById('fpsCounter').textContent = 'FPS: 0';
            }
        }
        
        function takeScreenshot() {
            const canvas = document.getElementById('displayCanvas');
            if (canvas.style.display === 'block') {
                const link = document.createElement('a');
                link.download = `screenshot_${Date.now()}.jpg`;
                link.href = canvas.toDataURL('image/jpeg');
                link.click();
            }
        }
        
        function logout() {
            stopMonitoring();
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = 'login.html';
        }
        
        // åˆå§‹è¼‰å…¥
        loadCameras();
        
        // é é¢é—œé–‰æ™‚åœæ­¢ç›£æ§
        // window.addEventListener('beforeunload', () => {
        //     stopMonitoring();
        // });
        // window.addEventListener('beforeunload', (e) => {
        //     if (isMonitoring && !isNavigating) {
        //         stopMonitoring();
        //         e.preventDefault();
        //         e.returnValue = 'ç›£æ§é€²è¡Œä¸­';
        //         return e.returnValue;
        //     }
        // });
        
        window.addEventListener('beforeunload', (e) => {
        if (isMonitoring) {
            // åªæ˜¯è¨˜éŒ„,ä¸è¦åœæ­¢ç›£æ§
            console.log('âš ï¸ é é¢å³å°‡é—œé–‰');
            // ä¸è¦å‘¼å« stopMonitoring()
            }
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>