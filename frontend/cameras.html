<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>攝影機管理 - 吸菸監控系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="./css/cameras.css">
</head>
<body>
    <!--收縮側邊欄按鈕-->
    <div class="toggle-btn" onclick="toggleSidebar()">
        <i class="bi bi-list"></i>
    </div>
    <!-- 側邊欄 -->
    <div class="sidebar">
        <div class="logo">
            <i class="bi bi-camera-video-off"></i>
            <h5 class="mt-2">吸菸監控系統</h5>
        </div>
        
        <nav class="nav flex-column">
            <a class="nav-link" href="dashboard.html">
                <i class="bi bi-speedometer2"></i> 儀表板
            </a>
            <a class="nav-link active" href="cameras.html">
                <i class="bi bi-camera"></i> 攝影機管理
            </a>
            <a class="nav-link" href="monitor.html">
                <i class="bi bi-display"></i> 即時監控
            </a>
            <a class="nav-link" href="detections.html">
                <i class="bi bi-list-ul"></i> 偵測記錄
            </a>
            <a class="nav-link" href="settings.html">
                <i class="bi bi-gear"></i> 系統設定
            </a>
            <a class="nav-link" href="#" onclick="logout()">
                <i class="bi bi-box-arrow-right"></i> 登出
            </a>
        </nav>
    </div>
    
    <!-- 主要內容 -->
    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-camera"></i> 攝影機管理</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCameraModal">
                <i class="bi bi-plus-circle"></i> 新增攝影機
            </button>
        </div>
        
        <div id="camerasList" class="row g-4">
            <div class="col-12 text-center">
                <p class="text-muted">載入中...</p>
            </div>
        </div>
    </div>
    
    <!-- 新增攝影機 Modal -->
    <div class="modal fade" id="addCameraModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-circle"></i> 新增攝影機</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addCameraForm">
                        <div class="mb-3">
                            <label class="form-label">攝影機名稱</label>
                            <input type="text" class="form-control" id="cameraName" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">攝影機類型</label>
                            <select class="form-select" id="cameraType" required>
                                <option value="usb">USB 攝影機</option>
                                <option value="rtsp">RTSP 串流</option>
                                <option value="local">本地攝影機</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">來源</label>
                            <input type="text" class="form-control" id="cameraSource" required placeholder="例如: 0, rtsp://...">
                            <small class="text-muted">USB/本地: 0, 1, 2... | RTSP: rtsp://username:password@ip:port/stream</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">位置</label>
                            <input type="text" class="form-control" id="cameraLocation" placeholder="例如: 辦公室一樓">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addCamera()">新增</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- API Key Modal -->
    <div class="modal fade" id="apiKeyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-check-circle"></i> 攝影機新增成功！</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>請妥善保管以下 API Key，客戶端需要使用它來連線：</p>
                    <div class="alert alert-warning">
                        <strong>API Key:</strong>
                        <div class="input-group mt-2">
                            <input type="text" class="form-control" id="apiKeyDisplay" readonly>
                            <button class="btn btn-outline-secondary" onclick="copyApiKey()">
                                <i class="bi bi-clipboard"></i> 複製
                            </button>
                        </div>
                    </div>
                    <p class="text-danger"><i class="bi bi-exclamation-triangle"></i> 注意：此 API Key 只會顯示一次，請立即複製保存！</p>
                    
                    <h6 class="mt-3">客戶端啟動指令：</h6>
                    <div class="bg-dark text-white p-3 rounded">
                        <code id="clientCommand">python client/camera_client.py --server ws://localhost:8000 --api-key YOUR_API_KEY --type usb --source 0</code>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">我已複製</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        
        if (!token) {
            window.location.href = 'login.html';
        }
        
        // 載入攝影機列表
        async function loadCameras() {
            try {
                const response = await fetch(`${API_URL}/api/cameras`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const cameras = await response.json();
                displayCameras(cameras);
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        function displayCameras(cameras) {
            const container = document.getElementById('camerasList');
            
            if (cameras.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center">
                        <i class="bi bi-camera-video-off" style="font-size: 80px; color: #ccc;"></i>
                        <p class="text-muted mt-3">目前沒有攝影機，點擊上方按鈕新增</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = cameras.map(camera => `
                <div class="col-md-4">
                    <div class="card camera-card">
                        <div class="card-body position-relative">
                            <span class="status-badge badge ${camera.is_online ? 'bg-success' : 'bg-secondary'}">
                                <i class="bi bi-${camera.is_online ? 'wifi' : 'wifi-off'}"></i>
                                ${camera.is_online ? '線上' : '離線'}
                            </span>
                            
                            <h5 class="card-title mt-2">
                                <i class="bi bi-camera"></i> ${camera.camera_name}
                            </h5>
                            
                            <p class="card-text">
                                <small class="text-muted">
                                    <i class="bi bi-tag"></i> ${camera.camera_type.toUpperCase()}<br>
                                    <i class="bi bi-geo-alt"></i> ${camera.location || '未設定位置'}<br>
                                    <i class="bi bi-link-45deg"></i> ${camera.camera_source}
                                </small>
                            </p>
                            
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary flex-fill" onclick="editCamera(${camera.id})">
                                    <i class="bi bi-pencil"></i> 編輯
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteCamera(${camera.id}, '${camera.camera_name}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // 新增攝影機
        async function addCamera() {
            const name = document.getElementById('cameraName').value;
            const type = document.getElementById('cameraType').value;
            const source = document.getElementById('cameraSource').value;
            const location = document.getElementById('cameraLocation').value;
            
            try {
                const response = await fetch(`${API_URL}/api/cameras`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        camera_name: name,
                        camera_type: type,
                        camera_source: source,
                        location: location
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // 關閉新增視窗
                    bootstrap.Modal.getInstance(document.getElementById('addCameraModal')).hide();
                    
                    // 顯示 API Key
                    document.getElementById('apiKeyDisplay').value = data.api_key;
                    document.getElementById('clientCommand').textContent = 
                        `python client/camera_client.py --server ws://localhost:8000 --api-key ${data.api_key} --type ${type} --source ${source}`;
                    
                    new bootstrap.Modal(document.getElementById('apiKeyModal')).show();
                    
                    // 重新載入列表
                    loadCameras();
                    
                    // 清空表單
                    document.getElementById('addCameraForm').reset();
                } else {
                    alert('新增失敗: ' + (data.detail || '未知錯誤'));
                }
            } catch (error) {
                alert('連線失敗');
                console.error('Error:', error);
            }
        }
        
        function copyApiKey() {
            const apiKey = document.getElementById('apiKeyDisplay');
            apiKey.select();
            document.execCommand('copy');
            alert('API Key 已複製到剪貼簿！');
        }
        
        async function deleteCamera(id, name) {
            if (!confirm(`確定要刪除攝影機「${name}」嗎？`)) return;
            
            try {
                const response = await fetch(`${API_URL}/api/cameras/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    alert('刪除成功');
                    loadCameras();
                }
            } catch (error) {
                alert('刪除失敗');
            }
        }
        
        function editCamera(id) {
            alert('編輯功能開發中...');
        }
        
        function logout() {
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = 'login.html';
        }
         //動態導覽列
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleBtn = document.querySelector('.toggle-btn');

            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('collapsed');
            toggleBtn.classList.toggle('collapsed');
        }
        // 初始載入
        loadCameras();
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>